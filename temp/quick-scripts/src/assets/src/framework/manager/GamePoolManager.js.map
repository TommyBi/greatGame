{"version":3,"sources":["assets/src/framework/manager/GamePoolManager.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import BasePoolObject from \"../base/BasePoolObject\";\n\n//游戏对象池 TODO 缓存依附对象的唯一id,重新class 自增id\nclass GamePoolManager {\n    private poolDic = {};\n    private pobjectCaches = [];//实例prefab对象的缓存\n    private objectIndex: number = 0;\n    private prefabIndex: number = 0;  //prefab的index\n    private prePrefabName: string = null;//上一个prefab的名称\n    private static _instance: GamePoolManager;\n\n    static getInstance(): GamePoolManager {\n        if (!this._instance) {\n            this._instance = new GamePoolManager();\n        }\n        return this._instance;\n    }\n\n    //注册的时候 target 支持 class 和 string两种类型\n    instance(prefab, target): cc.Node {\n        if (!!prefab) {\n            let targetId = this._getTargetKey(target);\n            if (!targetId) {\n                cc.error('实例Prefab没有设置target或者target不是class-->' + prefab.name);\n                return null;\n            }\n\n            //优化 查询速度\n            if (prefab.name != this.prePrefabName) {\n                this.prefabIndex = 0;\n                this.prePrefabName = prefab.name;\n            }\n\n            if (!this.poolDic.hasOwnProperty(prefab.name)) {\n                this.poolDic[prefab.name] = [];\n            }\n\n            let arr = this.poolDic[prefab.name];\n            for (let index = this.prefabIndex; index < arr.length; index++) {\n                if (!arr[index].isActive && cc.isValid(arr[index].prefab)) {\n                    arr[index].setTarget(targetId);\n                    this.prefabIndex = index;\n                    return arr[index].prefab;\n                }\n            }\n            let object = this._getObject();\n            let instance = cc.instantiate(prefab);\n            targetId = this._getTargetKey(instance);\n            object.setData(prefab.name, instance, targetId);\n            arr.push(object);\n            this.prefabIndex = arr.length - 1;\n            return instance;\n        }\n        return null;\n    }\n\n    /**\n     * 放回对象身上的某个实例\n     * @param target \n     * @param node \n     */\n    putBackItem(target, node) {\n        if (!cc.isValid(node)) {\n            return;\n        }\n        let elements = this._getObjectByTarget(target);\n        this.prefabIndex = 0;\n        if (!!elements) {\n            for (let index = 0; index < elements.length; index++) {\n                const element = elements[index];\n                if (element.isSameNode(node.uuid)) {\n                    element.reset();\n                }\n            }\n        }\n    }\n\n    /**\n     * 回收所有对应的prefab名\n     * @param name \n     */\n    putBackByName(name) {\n        if (this.poolDic.hasOwnProperty(name)) {\n            this.prefabIndex = 0;\n            let elements = this.poolDic[name];\n            if (!!elements) {\n                for (let index = 0; index < elements.length; index++) {\n                    const element = elements[index];\n                    element.reset();\n                }\n            }\n        }\n    }\n\n    putBackByTarget(target) {\n        let elements = this._getObjectByTarget(target);\n        this.prefabIndex = 0;\n        if (!!elements) {\n            for (let index = 0; index < elements.length; index++) {\n                const element = elements[index];\n                element.reset();\n            }\n        }\n    }\n\n    clearByTarget(target) {\n        let elements = this._getObjectByTarget(target);\n        this.prefabIndex = 0;\n        if (!!elements) {\n            for (let index = 0; index < elements.length; index++) {\n                const element = elements[index];\n                element.clear();\n            }\n            elements.length = 0;\n            this._resetObjectIndex();\n        }\n    }\n\n    //name 是prefab的名称\n    clearByName(name) {\n        if (this.poolDic.hasOwnProperty(name)) {\n            this.prefabIndex = 0;\n            let elements = this.poolDic[name];\n            if (!!elements) {\n                for (let index = 0; index < elements.length; index++) {\n                    const element = elements[index];\n                    element.clear();\n                }\n                elements.length = 0;\n                this._resetObjectIndex();\n            }\n        }\n    }\n    /**\n     * \n     * @param target \n     */\n    private _getObjectByTarget(target) {\n        if (!!target) {\n            let results = [];\n            let classID = this._getTargetKey(target);\n            if (!!classID) {\n                for (const key in this.poolDic) {\n                    const elements = this.poolDic[key];\n                    if (!!elements && elements.length > 0) {\n                        for (let index = 0; index < elements.length; index++) {\n                            const element = elements[index];\n                            const id = element.target;\n                            if (classID === id) {\n                                results.push(element);\n                            }\n                        }\n\n                    }\n                }\n                return results;\n            } else {\n                cc.error('GamePoolHelper 放回 或者清理时 target 不合法');\n            }\n\n            return null;\n        }\n        return null;\n    }\n\n    //获得需要缓存对象的key\n    private _getTargetKey(target) {\n        let targetId = null;\n        if (!!target) {\n            let isStr = cc.js.isString(target);\n            if (isStr) {\n                targetId = target\n            } else {\n                if (!!target.uuid) {\n                    targetId = target.uuid;\n                } else {\n                    targetId = cc.js._getClassId(target);\n                }\n            }\n        } else {\n            cc.error('GamePoolHelper中缓存对象不存在');\n        }\n        return targetId;\n    }\n\n    //重置壳子 可用的索引\n    private _resetObjectIndex() {\n        for (let index = 0; index < this.pobjectCaches.length; index++) {\n            const element = this.pobjectCaches[index];\n            if (!element.isObjectActive) {\n                this.objectIndex = index;\n                break;\n            }\n        }\n    }\n\n    private _getObject() {\n        for (let index = this.objectIndex; index < this.pobjectCaches.length; index++) {\n            const element = this.pobjectCaches[index];\n            if (!element.isObjectActive) {\n                this.objectIndex = index;\n                return element;\n            }\n        }\n        let obj = new BasePoolObject();\n        this.pobjectCaches.push(obj);\n        this.objectIndex = this.pobjectCaches.length - 1;\n        return obj;\n    }\n    \n\n    rolePool: cc.NodePool;\n    initRolePool(prefab) {\n        this.rolePool = new cc.NodePool();\n        let initCount = 5;\n        for (let i = 0; i < initCount; ++i) {\n            let role = cc.instantiate(prefab); // 创建节点\n            this.rolePool.put(role); // 通过 put 接口放入对象池\n        }\n    }\n\n\n    createRole(prefab) {\n        let role = null;\n        if (this.rolePool.size() > 0) { // 通过 size 接口判断对象池中是否有空闲的对象\n            role = this.rolePool.get();\n        } else { // 如果没有空闲对象，也就是对象池中备用对象不够时，我们就用 cc.instantiate 重新创建\n            role = cc.instantiate(prefab);\n        }\n        return role;\n    }\n\n    putRole(role) {\n        this.rolePool.put(role);\n    }\n}\n\nexport default GamePoolManager.getInstance();"]}