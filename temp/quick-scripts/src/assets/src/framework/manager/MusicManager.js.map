{"version":3,"sources":["assets/src/framework/manager/MusicManager.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import Global from \"../../game/consts/Global\";\nimport PlayerModel from \"../../game/datas/PlayerModel\";\nimport Handler from \"../base/Handler\";\nimport StorageHelper from \"../helper/StorageHelper\";\n\nclass MusicManager\n{\n    private _musicVolume : number = 1;\n    private _switchEffect : boolean =  true;//是否开启音效\n    private _switchMusic : boolean = true;//是否开启背景音效\n    private _playEffect  = {};\n    private cacheClips = {};\n    private _lastEffect: string = '';//上一次播放的音效\n    private _lastMusic: string = '';//上次播放的音乐\n\n    private static _instance:MusicManager;\n    \n    private preURL:string = 'sound/';//音效路径的前缀\n\n    public static instance():MusicManager\n    {\n        if (!this._instance) {\n            this._instance = new MusicManager();\n        }\n        return this._instance;\n    }\n\n\n    /**\n     * 播放音效文件\n     * url: 音效文件相对地址\n     * loop: 是否循环播放\n     * isSign: 每次只能播放一次 如果同时播放多个时 则后边的会全部不播放\n     * isStopPre\n     */\n\n    /**\n     * 播放音效文件\n     * @param url 音效文件相对地址\n     * @param loop 是否循环播放\n     * @param isSign 每次只能播放一次 如果同时播放多个时 则后边的会全部不播放\n     * @param isStopPre 播放同一个音效时 是否停止上一个音效\n     * @param handler  播放完成的回调函数\n     * @returns \n     */\n    playEffect(url:string,loop:boolean=false,isSign:boolean=false,isStopPre:boolean=false,handler:Handler=null)\n    {\n        if(this._switchEffect)\n        {\n            if (isSign) {\n                if (this._lastEffect == url) {\n                    return;\n                }\n            }\n\n            if ( isStopPre ) {\n                this.stopEffect(url);\n            }\n            this._lastEffect = url;\n            url = this.preURL + url;\n            let clip = this._getClip(url);\n            let effectId = -1;\n            if (!!clip) {\n                effectId = cc.audioEngine.playEffect(clip, loop);\n                if ( !loop && handler) {\n                    cc.audioEngine.setFinishCallback( effectId,(id)=>{\n                        handler.call();\n                    } );\n                }\n                this._playEffect[url] = effectId;\n            } else {\n                cc.loader.loadRes(url, cc.AudioClip, (err, clip) =>{\n                    effectId = cc.audioEngine.playEffect(clip, loop);\n                    if ( !loop && handler ) {\n                        cc.audioEngine.setFinishCallback( effectId,(id)=>{\n                            handler.call();\n                        } );\n                    }\n                    this.cacheClips[url] = clip;\n                    this._playEffect[url] = effectId;\n                });\n            }\n            \n        }\n    }\n\n    clearLastEffect(){\n        this._lastEffect = null;\n    }\n\n    stopEffectByID(id:number)\n    {\n        cc.audioEngine.stopEffect(id);\n    }\n\n    stopEffect(url)\n    {\n        let effectId = this._playEffect[this.preURL + url];\n        delete this._playEffect[this.preURL + url];\n        cc.audioEngine.stopEffect(effectId);\n    }\n\n    /**\n     * 背景音乐播放\n     * url: 资源路径\n     * loop: 是否循环\n     */\n    playMusic (url:string, loop:boolean=false){\n        if(this._switchMusic){\n            if (this._lastMusic === url) {\n                return;\n            }\n            this._lastMusic = url;\n            url = this.preURL + url;\n            let clip = this._getClip(url);\n            if (!!clip) {\n                cc.audioEngine.playMusic(clip, loop);    \n            } else {\n                cc.loader.loadRes(url, cc.AudioClip, (err, clip) =>{\n                    cc.audioEngine.playMusic(clip, loop);\n                    this.cacheClips[url] = clip;\n                });\n            }\n            \n        }\n    }\n    getLastMusic(){\n        if(this._lastMusic == ''){\n            return null;\n        }else{\n            return this._lastMusic;\n        }\n    }\n\n        /**\n     * 暂停当前播放音乐\n     */\n    setPauseMusic()\n    {\n        cc.audioEngine.pauseMusic();\n    }\n\n    /**\n     * 恢复当前被暂停音乐音乐\n     */\n    setResumeMusic()\n    {\n        cc.audioEngine.resumeMusic();\n    }\n\n    /**\n     * 重新播放该背景音乐\n     */\n    replayMusic()\n    {\n        cc.audioEngine.resumeMusic();\n    }\n\n    /**\n     * 停止播放音乐\n     * releaseData： 控制是否释放音乐资源 true释放资源 | false不释放资源\n     */\n    setStopMusic(releaseData = true)\n    {\n        cc.audioEngine.stopMusic();\n    }\n\n    setMusicVolume(value)\n    {\n        this._musicVolume = value;\n        cc.audioEngine.setMusicVolume(value);\n    }\n\n    getMusicVolume()\n    {\n        return cc.audioEngine.getMusicVolume();\n    }\n\n    setEffectSwitch(value)\n    {\n        this._switchEffect = value;\n        StorageHelper.saveValueByKey('audio',value);\n    }\n\n    setMusicSwitch(value){\n        this._switchMusic = value;\n        if (!value) {\n            this.setPauseMusic();\n        } else {\n            this.setResumeMusic();\n        }\n        StorageHelper.saveValueByKey('music',value);\n    }\n\n    getEffectSwitch()\n    {\n        return PlayerModel.getSoundYinXiaoSwitch() == true;\n    }\n\n    getMusicSwitch()\n    {\n        // let statusStr = StorageHelper.getValueByKey('music');\n        // let status = true;\n        // if (statusStr != null) {\n        //     if(typeof statusStr != \"boolean\")\n        //     {\n        //         if(statusStr === 'false') {\n        //             status = false;\n        //         } else {\n        //             status = true;\n        //         }\n        //     } else {\n        //         status = statusStr;\n        //     }\n        // } else {\n        //     status = true;\n        // }\n        // return status;\n        return PlayerModel.getSoundSwitch() == true;\n    }\n\n    initMusic()\n    {\n        this._switchEffect = this.getEffectSwitch();\n        this._switchMusic = this.getMusicSwitch();\n    }\n\n    /** \n     * 音乐是否正在播放（验证些方法来实现背景音乐是否播放完成）\n     * return boolen\n     */\n    isMusicPlaying()\n    {\n        return cc.audioEngine.isMusicPlaying();\n    }\n\n    /**\n     * 释放指定音效资源\n     * @param url 地址\n     * @param isEffect 是否是音效 \n     */\n    releaseAudio(url:string,isEffect:boolean=false){\n        let clip = this._getClip(this.preURL + url);\n        if( clip ){\n            if ( isEffect ) {\n                this.stopEffect(url);\n            } else {\n                this.setStopMusic();\n            }\n            delete this.cacheClips[url];\n            cc.audioEngine.uncache(clip);\n        }else{\n            cc.error(\"【音频】资源\" + url + \"不存在,释放失败\");\n        }\n    }\n\n    releaseAllAudio()\n    {\n        cc.audioEngine.uncacheAll();\n    }\n\n    _getClip(name){\n        if (this.cacheClips.hasOwnProperty(name)) {\n            return this.cacheClips[name];\n        }\n        return null;\n    }\n}\n\nexport default MusicManager.instance();"]}